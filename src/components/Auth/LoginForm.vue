<template>
  <!-- Formulario de login -->
  <form @submit.prevent="onSubmit" class="space-y-4">
    <div>
      <label for="documento" class="block text-sm font-medium text-white">Documento</label>
      <input
        id="documento"
        v-model="form.documentNumber"
        type="text"
        required
        class="mt-1 w-full rounded-xl border border-gray-600 bg-[#2b2f33] p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#7ED957]"
        placeholder="x.xxx.xxx.xxx"
      />
    </div>
    <div>
      <label for="password" class="block text-sm font-medium text-white">Contraseña</label>
      <input
        id="password"
        v-model="form.password"
        type="password"
        required
        minlength="6"
        class="mt-1 w-full rounded-xl border border-gray-600 bg-[#2b2f33] p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#7ED957]"
        placeholder="••••••••"
      />
    </div>
    <!-- <button type="submit" href="/dashboard" class="w-full btn bg-[#7ED957] text-[#0b1220] hover:brightness-90">
      Ingresar
    </button> -->

    <RouterLink
       class="w-full btn bg-[#7ED957] text-[#0b1220] hover:brightness-90"
      to="/dashboard"
      >Ingresar
      </RouterLink>
  </form>
</template>

<script setup lang="ts">
import { reactive, ref } from 'vue'
import { useRouter } from 'vue-router' // Asegúrate de que 'vue-router' esté correctamente instalado
import axios from 'axios'
import { useUserStore } from '../../store/userStore'

interface LoginFormData {
  documentNumber: string
  password: string
}

const form = reactive<LoginFormData>({
  documentNumber: '',
  password: '',
})

const error = ref('')
const router = useRouter() // Instancia el router correctamente

const api = axios.create({
  baseURL: 'http://127.0.0.1:8000/api',
  headers: { 'Content-Type': 'application/json' },
})

async function onSubmit() {
  error.value = ''

  try {
    const payload = {
      documento: form.documentNumber,
      password: form.password,
    }

    const res = await api.post('/login/', payload)

    // Guardar tokens
    localStorage.setItem('access_token', res.data.access)
    localStorage.setItem('refresh_token', res.data.refresh)

    // Setear el usuario en el store
    const userStore = useUserStore()
    userStore.setUser(res.data.role)

    // Redirección según el rol
    const userRole = res.data.role

    if (userRole === 'Aprendiz') {
      router.push({ name: 'dashboard-aprendiz' })
    } else if (userRole === 'Instructor') {
      router.push({ name: 'dashboard-instructor' })
    } else if (userRole === 'Administrador') {
      router.push({ name: 'dashboard-admin' })
    }
  } catch (err: any) {
    console.error('Error completo del backend:', err)
    error.value = err.response?.data?.error || 'Error en el login'
  }
}
</script>
